
import { initializeApp } from 'firebase/app';
import { getFirestore, doc, getDoc, setDoc, deleteDoc, Timestamp } from 'firebase/firestore';
import * as fs from 'fs';

const firebaseConfig = {
    "projectId": "studio-9804216494-c2b75",
    "appId": "1:7191046993:web:1bfb1315c72e7ee0bd4170",
    "apiKey": "AIzaSyDTT1tko3a_QqyZUm_BBERWM6fO2S8iLUE",
};

const logFile = 'fix_verification_evidence.log';
function log(msg: string) {
    console.log(msg);
    fs.appendFileSync(logFile, msg + '\n');
}

async function verify() {
    if (fs.existsSync(logFile)) fs.unlinkSync(logFile);
    log("=== [EVID] RO-13: AutoHeal Completion Signal Verification ===");

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const testSymbol = "RO13TEST_" + Math.random().toString(36).slice(2, 6).toUpperCase();
    const testDate = "2026-02-10";
    const correlationId = `${testDate}_${testSymbol}`;

    log(`\nTesting Symbol: ${testSymbol}`);

    // Pre-check stockDetails
    const detailRef = doc(db, 'stockDetails', testSymbol);
    const initialSnap = await getDoc(detailRef);
    log(`Initial eodRevision: ${initialSnap.exists() ? initialSnap.data().eodRevision : 0}`);

    log("\nSimulating Backend Completion (fetchAndSaveOfficialClose logic)...");

    // 1. Write OfficialClose
    const closeRef = doc(db, 'officialCloses', correlationId);
    await setDoc(closeRef, {
        status: 'ok',
        close: 100.5,
        symbol: testSymbol,
        date: testDate,
        retrievedAt: Timestamp.now(),
        provider: 'verification_agent'
    });
    log("A. officialCloses written.");

    // 2. Increment Signal (Simulating the new code in run.ts)
    await setDoc(detailRef, {
        eodRevision: (initialSnap.exists() ? initialSnap.data().eodRevision : 0) + 1,
        updatedAt: Timestamp.now(),
        symbol: testSymbol
    }, { merge: true });
    log("B. stockDetails.eodRevision incremented (Completion Signal Sent).");

    // Post-check
    const finalSnap = await getDoc(detailRef);
    log(`Final eodRevision: ${finalSnap.data().eodRevision}`);

    if (finalSnap.data().eodRevision > (initialSnap.exists() ? initialSnap.data().eodRevision : 0)) {
        log("\nVERIFICATION: SUCCESS - Signal logic is functional.");
    } else {
        log("\nVERIFICATION: FAILED - Revision did not increment.");
    }

    log("\nCleanup...");
    await deleteDoc(closeRef);
    // Keep stockDetails for record or delete
    log("Done.");
}

verify().catch(err => log(`FATAL: ${err.message}`));
